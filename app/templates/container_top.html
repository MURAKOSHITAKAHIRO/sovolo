{% extends "base.html" %}
{% load event_tags %}
{% load bootstrap3 %}
{% load static %}

{% block container %}

<div class="container-fluid" id="top-image" style="background: url({% static 'img/topimg.jpg' %}) no-repeat;">
  <h2>はじめよう、つながろう</h2>
  <div class="container-fluid-button">
    <a href="/event/add/">ボランティアをはじめる</a>
  </div>
</div>

<!-- Swiper -->
<div class="swiper-container">
    <div class="swiper-wrapper" id="swiper-wrapper">
    </div>
    <div class="swiper-pagination"></div>
    <div class="swiper-button-prev"></div>
    <div class="swiper-button-next"></div>
</div>

{% verbatim %}
<script id="slide-template" type="text/x-handlebars-template">
  {{#each filtered_events}}
  <div class="swiper-slide">
    <div class="card row">
      <a class="card-img col-xs-6" href="/event/{{id}}">
        <img src="{{img}}" alt="トップ画像">
      </a>
      <div class="card-block col-xs-6">
        <a href="/event/{{id}}"><h4 class="card-title">{{name}}</h4></a>
        <p class="card-text">
          <i class="fa fa-calendar" aria-hidden="true"></i>
          {{start_time}}
          <br>
          <i class="fa fa-map-marker" aria-hidden="true"></i>
          {{place}}
        </p>
        <a href="/event/{{id}}/support" class="btn btn-success align-bottom">応援する</a>
      </div>
    </div>
  </div>
  {{/each}}
</script>
{% endverbatim %}


<script>
  var template;
  $(function(){
    moment.updateLocale('ja', {
      weekdays: ["日曜日","月曜日","火曜日","水曜日","木曜日","金曜日","土曜日"],
      weekdaysShort: ["日","月","火","水","木","金","土"],
    });
    var slide_template = Handlebars.compile($("#slide-template").html());
    var slide_content = $(".event-filter:first-of-type");
    $.ajax({
        'url':slide_content.attr("action"),
        'data':slide_content.serialize(),
        'type':'POST',
        'dataType':'json',
      }).done(function(response){
        for(var i=0;i<response['filtered_events'].length;i++){
          response['filtered_events'][i]['start_time'] = moment(response['filtered_events'][i]['start_time']).format("M月D日(dd)");
        }
        console.log(slide_template(response));
        $('#swiper-wrapper').html(slide_template(response));
      }).fail(function(){
        console.log("取得に失敗")
    });

    template = Handlebars.compile($("#event-template").html());
    var opts = {
      lines: 13, //線の数
      length: 33, //線の長さ
      width: 11, //線の幅
      radius: 16, //スピナーの内側の広さ
      corners: 1, //角の丸み
      rotate: 74, //向き(あんまり意味が無い・・)
      direction: 1, //1：時計回り -1：反時計回り
      color: '#000', // 色
      speed: 1.5, // 一秒間に回転する回数
      trail: 71, //残像の長さ
      shadow: true, // 影
      hwaccel: true, // ？
      className: 'spinner', // クラス名
      zIndex: 2e9, // Z-index
      top: '50%', // relative TOP
      left: '50%', // relative LEFT
      opacity: .25, //透明度
      fps: 20 //fps
    };
    //描画先の親要素
    var spin_target = $("#event-area").get(0);
    //スピナーオブジェクト
    var spinner = new Spinner(opts);
    //スピナー描画
    spinner.spin(spin_target);
    //もう一度spinを呼ぶとスピナー停止
    var init = $(".event-filter:first-of-type");
    $.ajax({
        'url':init.attr("action"),
        'data':init.serialize(),
        'type':'POST',
        'dataType':'json',
      }).done(function(response){
        show_events(response);
      }).fail(function(){
        console.log("取得に失敗")
    });
    $('.event-filter').on('click',function(){
      $('.event-filter').removeClass('event-active');
      $(this).addClass('event-active')
      $.ajax({
        'url':$(this).attr('action'),
        'data':$(this).serialize(),
        'type':'POST',
        'dataType':'json',
      }).done(function(response){
        show_events(response);
      }).fail(function(){
        console.log("取得に失敗")
      });
    });
    console.log($('.swiper-container').get(0));
    var swiper = new Swiper('.swiper-container', {
      loop : true,
      pagination: '.swiper-pagination',
      nextButton: '.swiper-button-next',
      prevButton: '.swiper-button-prev',
      slidesPerView: 'auto',
      centeredSlides: true,
      paginationClickable: true,
      spaceBetween: 30
    });
    $('#top-tabs').tabs({
      selected  : 0,
    });

  })

  function show_events(context){
    for(var i=0;i<context['filtered_events'].length;i++){
      context['filtered_events'][i]['start_time'] = moment( context['filtered_events'][i]['start_time']).format("M月D日(dd)");
    }
    $('#event-area').html(template(context));
  }

</script>

<div id="main">
  <div id="main-content" class="container">
    {% if form.errors %}
      {% bootstrap_form_errors form %}
    {% endif %}
      <div class="messages">
        {% if messages %}
          {% for message in messages %}
            <p {% if message.tags %} class="{{ message.tags }}"{% endif %} >{{ message }}</p>
          {% endfor %}
        {% endif %}
      </div>
    {% block content %}{% endblock %}
  </div>
</div>
{% endblock %}
