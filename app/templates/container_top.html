{% extends "base.html" %}
{% load event_tags %}
{% load bootstrap3 %}
{% load static %}

{% block container %}

<div class="container-fluid" id="top-image" style="background: url({% static 'img/topimg.jpg' %}) no-repeat;">
  <h2>はじめよう、つながろう</h2>
  <div class="container-fluid-button">
    <a href="/event/add/">ボランティアをはじめる</a>
  </div>
</div>

<!-- Swiper -->
<div class="swiper-container">
    <div class="swiper-wrapper">
      {% for event in new_events %}
      <div class="swiper-slide">
        <div class="card">
          <a href="{% url 'event:detail' event.pk %}">
            <img class="card-img-top" src="{{ event.get_image_url }}" alt="トップ画像">
          </a>
          <div class="card-block">
            <a href="{% url 'event:detail' event.pk %}"><h4 class="card-title">{{event.name}}</h4></a>
            <p class="card-text">
              <i class="fa fa-calendar" aria-hidden="true"></i>
              {{event.start_time_format | date:'n/j (D)' }}
              <i class="fa fa-map-marker" aria-hidden="true"></i>
              {{event.get_region_kanji}}
            </p>
            <a href="{% url 'event:support' event.pk %}" class="btn btn-success d-inline-block align-bottom">応援する</a>
          </div>
        </div>
      </div>
      {% endfor %}
    </div>
    <div class="swiper-pagination"></div>
    <div class="swiper-button-prev"></div>
    <div class="swiper-button-next"></div>
</div>


<script>
  var template;
  $(function(){
    template = Handlebars.compile($("#event-template").html());
    moment.updateLocale('ja', {
      weekdays: ["日曜日","月曜日","火曜日","水曜日","木曜日","金曜日","土曜日"],
      weekdaysShort: ["日","月","火","水","木","金","土"],
    });
    var opts = {
      lines: 13, //線の数
      length: 33, //線の長さ
      width: 11, //線の幅
      radius: 16, //スピナーの内側の広さ
      corners: 1, //角の丸み
      rotate: 74, //向き(あんまり意味が無い・・)
      direction: 1, //1：時計回り -1：反時計回り
      color: '#000', // 色
      speed: 1.5, // 一秒間に回転する回数
      trail: 71, //残像の長さ
      shadow: true, // 影
      hwaccel: true, // ？
      className: 'spinner', // クラス名
      zIndex: 2e9, // Z-index
      top: '50%', // relative TOP
      left: '50%', // relative LEFT
      opacity: .25, //透明度
      fps: 20 //fps
    };
    //描画先の親要素
    var spin_target = $("#event-area").get(0);
    //スピナーオブジェクト
    var spinner = new Spinner(opts);
    //スピナー描画
    spinner.spin(spin_target);
    //もう一度spinを呼ぶとスピナー停止
    var init = $(".event-filter:first-of-type");
    $.ajax({
        'url':init.attr("action"),
        'data':init.serialize(),
        'type':'POST',
        'dataType':'json',
      }).done(function(response){
        show_events(response);
      }).fail(function(){
        console.log("取得に失敗")
    });
    $('.event-filter').on('click',function(){
      $('.event-filter').removeClass('event-active');
      $(this).addClass('event-active')
      $.ajax({
        'url':$(this).attr('action'),
        'data':$(this).serialize(),
        'type':'POST',
        'dataType':'json',
      }).done(function(response){
        show_events(response);
      }).fail(function(){
        console.log("取得に失敗")
      });
    });
  })

  function show_events(context){
    for(var i=0;i<context['filtered_events'].length;i++){
      context['filtered_events'][i]['start_time'] = moment().format("M月D日(dd)");
    }
    $('#event-area').html(template(context));
  }

</script>

<div id="main">
  <div id="main-content" class="container">
    {% if form.errors %}
      {% bootstrap_form_errors form %}
    {% endif %}
      <div class="messages">
        {% if messages %}
          {% for message in messages %}
            <p {% if message.tags %} class="{{ message.tags }}"{% endif %} >{{ message }}</p>
          {% endfor %}
        {% endif %}
      </div>
    {% block content %}{% endblock %}
  </div>
</div>
{% endblock %}
